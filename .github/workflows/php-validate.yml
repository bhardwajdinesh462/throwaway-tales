name: Validate PHP Backend

on:
  push:
    paths:
      - 'php-backend/**'
  pull_request:
    paths:
      - 'php-backend/**'
  workflow_dispatch:  # Allow manual trigger

jobs:
  php-validate:
    name: PHP Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: pdo_mysql, imap, mbstring, json, openssl
          
      - name: Validate PHP Syntax
        run: |
          echo "========================================="
          echo "üîç STEP 1: Validating PHP Syntax"
          echo "========================================="
          errors=0
          success=0
          error_files=""
          
          for file in $(find php-backend -name "*.php" -type f); do
            result=$(php -l "$file" 2>&1)
            if echo "$result" | grep -q "No syntax errors"; then
              echo "‚úì $file"
              success=$((success + 1))
            else
              echo "‚ùå $file"
              echo "$result"
              error_files="$error_files\n  - $file"
              errors=$((errors + 1))
            fi
          done
          
          echo ""
          echo "üìä Checked $((success + errors)) PHP files"
          
          if [ $errors -gt 0 ]; then
            echo ""
            echo "‚ùå FAILED: Found $errors PHP syntax error(s):"
            echo -e "$error_files"
            exit 1
          fi
          echo "‚úÖ All $success PHP files are syntactically correct"

      - name: Check for Duplicate Functions
        run: |
          echo ""
          echo "========================================="
          echo "üîç STEP 2: Checking for Duplicate Functions"
          echo "========================================="
          
          # Extract all function declarations with file and line info
          echo "Scanning for function declarations..."
          
          duplicates_found=0
          declare -A function_locations
          
          # Find all function declarations (excluding function_exists guards)
          while IFS=: read -r file line content; do
            # Skip if it's inside a function_exists check
            if echo "$content" | grep -q "function_exists"; then
              continue
            fi
            
            # Extract function name
            func_name=$(echo "$content" | grep -oP 'function\s+\K[a-zA-Z_][a-zA-Z0-9_]*' | head -1)
            
            if [ -n "$func_name" ]; then
              if [ -n "${function_locations[$func_name]}" ]; then
                echo "‚ùå DUPLICATE: $func_name"
                echo "   First declared: ${function_locations[$func_name]}"
                echo "   Also declared:  $file:$line"
                duplicates_found=$((duplicates_found + 1))
              else
                function_locations[$func_name]="$file:$line"
                echo "‚úì $func_name ($file:$line)"
              fi
            fi
          done < <(grep -rn "^\s*function\s\+[a-zA-Z_]" php-backend --include="*.php" 2>/dev/null || true)
          
          echo ""
          if [ $duplicates_found -gt 0 ]; then
            echo "‚ùå FAILED: Found $duplicates_found duplicate function declaration(s)"
            echo ""
            echo "üí° Fix: Rename one of the duplicates or wrap with function_exists()"
            exit 1
          fi
          echo "‚úÖ No duplicate function declarations found"

      - name: Check for Stray Code
        run: |
          echo ""
          echo "========================================="
          echo "üîç STEP 3: Checking for Stray Code Patterns"
          echo "========================================="
          
          issues=0
          
          # Check for unmatched braces (simple heuristic)
          echo "Checking for potential brace issues..."
          for file in $(find php-backend -name "*.php" -type f); do
            open_braces=$(grep -o '{' "$file" | wc -l)
            close_braces=$(grep -o '}' "$file" | wc -l)
            if [ "$open_braces" -ne "$close_braces" ]; then
              echo "‚ö†Ô∏è  Brace mismatch in $file: { = $open_braces, } = $close_braces"
              issues=$((issues + 1))
            fi
          done
          
          # Check for git merge conflict markers
          echo "Checking for merge conflict markers..."
          if grep -rn "<<<<<<\|>>>>>>\|======" php-backend --include="*.php" 2>/dev/null; then
            echo "‚ùå Found merge conflict markers!"
            issues=$((issues + 1))
          fi
          
          # Check for debug statements that shouldn't be committed
          echo "Checking for debug statements..."
          if grep -rn "var_dump\|print_r.*die\|exit.*debug" php-backend --include="*.php" 2>/dev/null | grep -v "// debug" | head -5; then
            echo "‚ö†Ô∏è  Found potential debug statements (review manually)"
          fi
          
          echo ""
          if [ $issues -gt 0 ]; then
            echo "‚ö†Ô∏è  Found $issues potential issue(s) - review recommended"
          else
            echo "‚úÖ No stray code patterns detected"
          fi
          
      - name: Check Required Files
        run: |
          echo ""
          echo "========================================="
          echo "üîç STEP 4: Checking Required Files"
          echo "========================================="
          
          required_files=(
            "php-backend/index.php"
            "php-backend/schema.sql"
            "php-backend/install.php"
            "php-backend/config.example.php"
            "php-backend/includes/db.php"
            "php-backend/includes/helpers.php"
            "php-backend/routes/admin.php"
            "php-backend/routes/auth.php"
            "php-backend/routes/data.php"
            "php-backend/routes/functions.php"
            "php-backend/routes/rpc.php"
            "php-backend/routes/webhooks.php"
            "php-backend/cron/imap-poll.php"
            "php-backend/cron/maintenance.php"
            "php-backend/cron/health-check.php"
          )
          
          missing=0
          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "‚úì $file"
            else
              echo "‚ùå Missing: $file"
              missing=$((missing + 1))
            fi
          done
          
          if [ $missing -gt 0 ]; then
            echo ""
            echo "‚ùå FAILED: Missing $missing required file(s)"
            exit 1
          fi
          echo ""
          echo "‚úÖ All required files present"
          
      - name: Validate Schema
        run: |
          echo ""
          echo "========================================="
          echo "üîç STEP 5: Validating Database Schema"
          echo "========================================="
          
          schema="php-backend/schema.sql"
          required_tables=("users" "emails" "domains" "mailboxes" "app_settings" "temp_emails" "received_emails")
          
          missing=0
          for table in "${required_tables[@]}"; do
            if grep -qi "CREATE TABLE.*\`\?$table\`\?" "$schema"; then
              echo "‚úì Table: $table"
            else
              echo "‚ùå Missing table: $table"
              missing=$((missing + 1))
            fi
          done
          
          if [ $missing -gt 0 ]; then
            echo ""
            echo "‚ùå FAILED: Missing $missing required table(s) in schema"
            exit 1
          fi
          echo ""
          echo "‚úÖ Schema validation passed"

      - name: Validation Summary
        if: always()
        run: |
          echo ""
          echo "========================================="
          echo "üìã VALIDATION SUMMARY"
          echo "========================================="
          echo "Run completed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "This workflow checks:"
          echo "  1. PHP syntax errors (php -l)"
          echo "  2. Duplicate function declarations"
          echo "  3. Stray code patterns (brace mismatches, merge markers)"
          echo "  4. Required files presence"
          echo "  5. Database schema completeness"
          echo ""
          echo "For more info, see: SELF-HOSTED-GUIDE.md"
